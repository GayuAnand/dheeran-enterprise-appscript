<div class="filter-row de-p-vbase">
  <mat-form-field>
    <mat-label>{{TKey.COMMON.SEARCH}}</mat-label>
    <input matInput type="text" [(ngModel)]="searchText" (ngModelChange)="onFilterChange()">
    <button *ngIf="searchText" matSuffix mat-icon-button (click)="searchText=''; onFilterChange();">
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>

  <mat-form-field>
    <mat-label>{{TKey.COMMON.STATUS}}</mat-label>
    <mat-select [formControl]="statusFilter.control" multiple>
      <div class="select-all">
        <mat-checkbox [(ngModel)]="statusFilter.selectAll"
                      [ngModelOptions]="{ standalone: true }"
                      (change)="statusFilter.toggleSelectAll()">Select All</mat-checkbox>
      </div>
      <mat-option *ngFor="let status of statusFilter.controlOptions" [value]="status" (click)="statusFilter.onSelectionChange()">{{status}}</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>{{TKey.COMMON.AREA}}</mat-label>
    <mat-select [formControl]="areaFilter.control" multiple>
      <div class="select-all">
        <mat-checkbox [(ngModel)]="areaFilter.selectAll"
                      [ngModelOptions]="{ standalone: true }"
                      (change)="areaFilter.toggleSelectAll()">Select All</mat-checkbox>
      </div>
      <mat-option *ngFor="let area of areaFilter.controlOptions" [value]="area" (click)="areaFilter.onSelectionChange()">{{area}}</mat-option>
    </mat-select>
  </mat-form-field>

  <p class="advanced-filter-label"><span (click)="toggleAdvancedFilters()" class="de-cursorpointer">{{showAdvancedFilters ? TKey.COMMON.HIDE_ADVANCED_FILTERS : TKey.COMMON.SHOW_ADVANCED_FILTERS}}</span></p>

  <ng-container *ngIf="showAdvancedFilters">
    <div class="pending-settlement-filter">
      <label>Pending Settlement Filter</label>
      <mat-slide-toggle [(ngModel)]="showPendingSettlement" (ngModelChange)="onFilterChange()" [ngClass]="authService.hasPermission(METADATA.APPS.CABLE, METADATA.ROLES.ADMIN) ? '' : 'de-nm--force'">{{TKey.CUSTOMERS.SHOW_PENDING_SETTLEMENT}} {{showPendingSettlement ? '(Rs.' + pendingSettlementAmount + '/-)' : ''}}</mat-slide-toggle>

      <mat-form-field *ngIf="authService.hasPermission(METADATA.APPS.CABLE, METADATA.ROLES.ADMIN)">
        <mat-label>{{TKey.COMMON.AGENTS}}</mat-label>
        <mat-select [formControl]="agentsFilter.control" multiple>
          <div class="select-all">
            <mat-checkbox [(ngModel)]="agentsFilter.selectAll"
                          [ngModelOptions]="{ standalone: true }"
                          (change)="agentsFilter.toggleSelectAll()">Select All</mat-checkbox>
          </div>
          <mat-option *ngFor="let area of agentsFilter.controlOptions" [value]="area" (click)="agentsFilter.onSelectionChange()">{{area}}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="collection-filter">
      <label>Collection Filter</label>
      <mat-slide-toggle [(ngModel)]="showCollectedCustomers" (ngModelChange)="onFilterChange()">{{showCollectedCustomers ? TKey.CUSTOMERS.SHOW_COLLECTED : TKey.CUSTOMERS.SHOW_PENDING_COLLECTION}}</mat-slide-toggle>

      <mat-form-field>
        <mat-label>{{TKey.COMMON.MONTHS}}</mat-label>
        <mat-select [formControl]="monthsFilter.control" multiple>
          <div class="select-all">
            <mat-checkbox [(ngModel)]="monthsFilter.selectAll"
                          [ngModelOptions]="{ standalone: true }"
                          (change)="monthsFilter.toggleSelectAll()">Select All</mat-checkbox>
          </div>
          <mat-option *ngFor="let area of monthsFilter.controlOptions" [value]="area" (click)="monthsFilter.onSelectionChange()">{{area}}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </ng-container>
</div>

<de-refresh-data [cacheInfo]="cacheInfo" (refresh)="refreshData(true)"></de-refresh-data>

<mat-table [dataSource]="data" class="mat-elevation-z8" multiTemplateDataRows>
  <ng-container matColumnDef="{{column}}" *ngFor="let column of displayedColumns">
    <mat-header-cell *matHeaderCellDef [ngClass]="'de-f-justifycenter'">{{column}}</mat-header-cell>

    <mat-cell *matCellDef="let element" [ngClass]="getCellClassNames(element, column)">
      <ng-container [ngSwitch]="column">

        <ng-container *ngSwitchCase="customerColumns?.STATUS?.label">
          <mat-icon>toggle_on</mat-icon>
        </ng-container>

        <ng-container *ngSwitchCase="customerColumns?.STB?.label">
          <de-copyable-text [text]="element[column]"></de-copyable-text>
        </ng-container>

        <ng-container *ngSwitchCase="customerColumns?.NAME?.label">
          {{element[column]}} {{showPendingSettlement ? '(' + element.getPendingSettlement(true) + ')' : ''}}
        </ng-container>

        <ng-container *ngSwitchCase="customerColumns?.MOBILE?.label">
          <ng-container *ngFor="let mobile of element.getMobileNumbers()">
            <div class="mobile-cell de-sm-rsmall-nolast" *ngIf="mobile">
              <de-copyable-text [text]="mobile"></de-copyable-text>
              <div class="de-f-aligncenter de-sm-rbase-nolast">
                <de-mobile-number [mobile]="mobile" displayType="CALL"></de-mobile-number>
                <de-mobile-number [mobile]="mobile" displayType="WHATSAPP"></de-mobile-number>
              </div>
            </div>
          </ng-container>
        </ng-container>

        <ng-container *ngSwitchDefault>{{element[column]}}</ng-container>
      </ng-container>
    </mat-cell>
  </ng-container>

  <ng-container matColumnDef="expandedDetail">
    <mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length" class="expanded-detail-cell" [ngClass]="element !== expandedElement ? 'de-noborder--force' : ''">
      <de-customer-card *ngIf="element === expandedElement" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'" [customer]="element"></de-customer-card>
    </mat-cell>
  </ng-container>

  <mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></mat-header-row>
  <mat-row *matRowDef="let row; columns: displayedColumns;" mat-ripple (click)="expandedElement = expandedElement === row ? null : row"></mat-row>
  <mat-row mat-row *matRowDef="let row; columns: ['expandedDetail']" class="expanded-detail-row"></mat-row>
</mat-table>

<mat-paginator [pageSizeOptions]="[25, 50, 100, 20]" pageSize="50" showFirstLastButtons></mat-paginator>
